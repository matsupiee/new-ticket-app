# 開発計画書

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [技術スタック](#2-技術スタック)
3. [開発フェーズ](#3-開発フェーズ)
4. [API 設計](#4-api-設計)
5. [admin フロントエンド設計](#5-admin-フロントエンド設計)
6. [web フロントエンド設計](#6-web-フロントエンド設計)
7. [テスト戦略](#7-テスト戦略)

---

## 1. プロジェクト概要

### 1.1 プロダクト概要

イベント主催者とチケット購入者を結ぶ総合チケット販売プラットフォームです。

**主要機能:**

- イベント・公演・チケット管理
- 先着/抽選/希望制の販売方式
- 複数決済手段（GMO、楽天、コンビニ）
- 電子チケット（QR コード）/ 紙チケット対応
- 入場管理システム

### 1.2 ユーザー種別

| ユーザー種別           | 説明                                                   |
| ---------------------- | ------------------------------------------------------ |
| 一般ユーザー           | チケット購入者                                         |
| 主催者                 | イベント・公演を管理する事業者                         |
| プラットフォーム管理者 | 全ての主催者の情報を閲覧できる。特別な設定なども行える |

---

## 2. 追加予定の技術

| カテゴリ   | 技術                 | 用途                                           |
| ---------- | -------------------- | ---------------------------------------------- |
| キュー     | BullMQ + Redis       | バックグラウンドジョブ（抽選処理、メール送信） |
| ストレージ | Google Cloud Storage | 画像・チケット PDF 保存                        |
| メール     | Resend               | 通知メール送信                                 |

---

## 3. 開発フェーズ

### Phase 1: ユーザー管理・認証

**目標:** ユーザー登録・ログイン・プロフィール管理

| タスク | 詳細                            | 要件 |
| ------ | ------------------------------- | ---- |
| 1.1    | ユーザー登録（メール/電話番号） | 1.1  |
| 1.2    | ログイン/ログアウト             | 1.1  |

---

### Phase 2: 組織・主催者管理

**目標:** 主催者向けの組織管理機能

| タスク | 詳細                     | 要件 |
| ------ | ------------------------ | ---- |
| 2.1    | 組織（事業所）登録・編集 | 2.1  |
| 2.2    | 銀行口座登録             | 2.1  |
| 2.5    | 主催者情報登録・編集     | 2.2  |

---

### Phase 3: イベント管理

**目標:** イベントの作成・編集・公開管理

| タスク | 詳細                       | 要件 |
| ------ | -------------------------- | ---- |
| 3.1    | イベント作成・編集・削除   | 3.1  |
| 3.2    | 開催期間設定               | 3.1  |
| 3.3    | カバー画像・サムネイル設定 | 3.1  |
| 3.4    | タグ付け（ジャンル分類）   | 3.1  |
| 3.5    | 公開/非公開切り替え        | 3.2  |
| 3.6    | 公開日時予約               | 3.2  |
| 3.7    | 注意事項・利用規約設定     | 3.3  |
| 3.8    | 下書き・プレビュー機能     | 16.1 |

---

### Phase 4: 公演管理

**目標:** 公演（ステージ）の管理機能

| タスク | 詳細                     | 要件 |
| ------ | ------------------------ | ---- |
| 4.1    | 公演作成・編集・削除     | 4.1  |
| 4.2    | 公演日時・会場設定       | 4.1  |
| 4.3    | アーティスト登録         | 4.2  |
| 4.4    | 出演者割り当て・順序設定 | 4.2  |
| 4.5    | 通し券定義               | 4.3  |
| 4.6    | 公演下書き機能           | 16.2 |

---

### Phase 5: チケット販売設定

**目標:** 販売スケジュール・制限・券種の設定

| タスク | 詳細                           | 要件     |
| ------ | ------------------------------ | -------- |
| 5.1    | 販売期間設定                   | 5.1      |
| 5.2    | 販売方式（先着/抽選/希望制）   | 5.1      |
| 5.3    | 入金期限設定                   | 5.1      |
| 5.4    | 当選発表日時設定               | 5.1      |
| 5.5    | 販売対象制限（会員限定等）     | 5.2      |
| 5.6    | 購入制限設定                   | 5.3      |
| 5.7    | 券種作成・編集                 | 6.1      |
| 5.8    | 座席設定                       | 6.2      |
| 5.9    | オプション設定（同行者人数等） | 6.3      |
| 5.10   | 副券（特典）設定               | 6.4      |
| 5.11   | 限定コンテンツ設定             | 6.5      |
| 5.12   | 売上分配ルール設定             | 7.1, 7.2 |

---

### Phase 6: 申込・購入フロー

**目標:** チケット購入の一連のフロー実装

| タスク | 詳細                   | 要件 |
| ------ | ---------------------- | ---- |
| 6.1    | チケット選択 UI        | 8.1  |
| 6.4    | 希望順位設定（希望制） | 8.3  |

---

### Phase 7: 決済処理

**目標:** 決済処理の基盤実装（モック実装）

| タスク | 詳細           | 要件 |
| ------ | -------------- | ---- |
| 7.1    | 決済モック実装 | 9.1  |

---

### Phase 8: チケット発行

**目標:** ユーザーにチケットを配布

| タスク | 詳細             | 要件 |
| ------ | ---------------- | ---- |
| 8.1    | チケット発行処理 | 10.1 |
| 8.2    | QR コード生成    | 10.1 |

---

### Phase 11: 入場管理

**目標:** 当日の入場処理システム

| タスク | 詳細                   | 要件 |
| ------ | ---------------------- | ---- |
| 11.1   | QR コード読取          | 14.1 |
| 11.3   | 入場時刻記録           | 14.1 |
| 11.5   | チケット有効性チェック | 14.2 |
| 11.6   | 重複入場防止           | 14.2 |

---

### Phase 13: お気に入り機能

**目標:** ユーザーのお気に入り管理

| タスク | 詳細                 | 要件 |
| ------ | -------------------- | ---- |
| 13.1   | アーティストフォロー | 15.1 |
| 13.3   | イベントブックマーク | 15.2 |

---

### Phase 14: プラットフォーム管理者機能

**目標:** 管理画面・運用機能

| タスク | 詳細                         | 要件 |
| ------ | ---------------------------- | ---- |
| 14.1   | トップページのカルーセル設定 | 17.1 |
| 14.3   | メンテナンスモード           | 17.2 |
| 14.7   | チケットステータス変更       | 20.2 |

---

### Phase 15: 分析・レポート

**目標:** 売上分析・統計機能

| タスク | 詳細               | 要件 |
| ------ | ------------------ | ---- |
| 15.1   | 販売状況レポート   | 19.1 |
| 15.2   | 券種別売上集計     | 19.1 |
| 15.3   | 日別・時間帯別推移 | 19.1 |
| 15.4   | お目当て集計       | 19.2 |

---

### Phase 16: 抽選処理

**目標:** 抽選販売の自動処理

| タスク | 詳細                 | 要件 |
| ------ | -------------------- | ---- |
| 16.1   | 抽選アルゴリズム実装 | 5.1  |
| 16.2   | 当選/落選処理        | 5.1  |
| 16.3   | 繰り上げ当選処理     | 5.1  |

---

## 4. API 設計

### 4.1 API 構成

oRPC を使用してエンドツーエンドの型安全な API を構築します。

```
packages/api/src/
├── router/
│   ├── index.ts              # ルートルーター
│   ├── user.ts               # ユーザー関連
│   ├── organization.ts       # 組織関連
│   ├── organizer.ts          # 主催者関連
│   ├── event.ts              # イベント関連
│   ├── performance.ts        # 公演関連
│   ├── sale.ts               # 販売設定関連
│   ├── ticket-type.ts        # 券種関連
│   ├── order.ts              # 注文関連
│   ├── payment.ts            # 決済関連
│   ├── ticket.ts             # チケット関連
│   ├── transfer.ts           # 分配関連
│   ├── resale.ts             # リセール関連
│   ├── refund.ts             # 返金関連
│   ├── admission.ts          # 入場関連
│   ├── favorite.ts           # お気に入り関連
│   ├── notification.ts       # 通知関連
│   └── admin.ts              # 管理者関連
├── middleware/
│   ├── auth.ts               # 認証ミドルウェア
│   ├── rateLimit.ts          # レート制限
│   └── logging.ts            # ログ
└── services/
    ├── payment/              # 決済サービス
    │   ├── gmo.ts
    │   ├── rakuten.ts
    │   └── convenience.ts
    ├── lottery.ts            # 抽選サービス
    ├── ticket.ts             # チケット発行サービス
    └── notification.ts       # 通知サービス
```

### 4.2 主要エンドポイント

#### ユーザー系

- `user.register` - ユーザー登録
- `user.login` - ログイン
- `user.profile.get` - プロフィール取得
- `user.profile.update` - プロフィール更新
- `user.paymentMethod.list` - 決済情報一覧
- `user.paymentMethod.add` - 決済情報追加

#### イベント系

- `event.list` - イベント一覧
- `event.get` - イベント詳細
- `event.create` - イベント作成（主催者）
- `event.update` - イベント更新（主催者）
- `event.publish` - イベント公開（主催者）

#### 購入系

- `order.create` - 申込作成
- `order.confirm` - 申込確定
- `order.cancel` - 申込キャンセル
- `payment.process` - 決済処理
- `payment.status` - 決済状況確認

#### チケット系

- `ticket.list` - チケット一覧
- `ticket.get` - チケット詳細
- `ticket.transfer.create` - 分配 URL 発行
- `ticket.transfer.accept` - 分配受取

---

## 5. admin フロントエンド設計

### 5.1 ページ構成

```
sign-up
sign-in
user
  index.tsx // ユーザーの一覧（チケット購入を行う一般ユーザーを閲覧・検索する）
event-organizer
  index.tsx // ここはプラットフォームuserしか見れない
  [eventOrganizerId] // プラットフォームuser、eventOrganizer権限userしか見れない
    index.tsx
    event
      index.tsx // イベント一覧
      [eventId]
        index.tsx
        edit
          index.tsx // イベント編集
          stage.tsx // 公演の情報を編集
          saleSchedule.tsx // 販売スケジュールを編集
        application.tsx // 申し込み一覧を表示
      create
        index.tsx // イベント作成
    favorite
      dashboard.tsx // お目当てのイベントやアーティストの分析
    sales
      dashboard.tsx // 売り上げダッシュボード
```

---

## 6. web フロントエンド設計

### 6.1 ページ構成

```
(auth)
  sign-up
  sign-in
  password
    reset
setting
  account
    index.tsx // アカウント設定
    profile.tsx
    email.tsx // メール設定
    phone-number.tsx // 電話番号設定
    card
      index.tsx // クレカ情報設定
artist
  [artistId]
    index.tsx // アーティスト詳細
event
  index.tsx
  [eventId]
    index.tsx // イベント詳細
    application
      index.tsx  // 申し込みページ
      error.tsx // 申し込みエラー
      done.tsx // 申し込み完了
ticket
  index.tsx // 所有チケット一覧
  [ticketId]
    index.tsx // 所有チケット詳細
favorite
  index.tsx // お気に入りイベント・アーティスト一覧
```

---

## 7. テスト戦略

### 7.1 テストの種類

server サイドだけ実装

| 種類           | ツール | 対象                             |
| -------------- | ------ | -------------------------------- |
| ユニットテスト | Vitest | ビジネスロジック、ユーティリティ |

### 7.2 テスト対象の優先度

**高優先度（必須）:**

- チケット販売情報の登録・編集
- チケット購入申込
- 決済処理
- 抽選ロジック
- チケット発行

### 7.3 テスト環境

```
# テストDB（Docker）
docker compose -f docker-compose.test.yml up -d

# テスト実行
pnpm test           # ユニットテスト
```

---

### 用語集

| 用語                             | 説明                           |
| -------------------------------- | ------------------------------ |
| 公演（Stage）                    | イベント内の個別の開催枠       |
| 販売スケジュール（SaleSchedule） | 販売期間・方式を定義したもの   |
| 券種（TicketType）               | チケットの種類（S 席、A 席等） |
